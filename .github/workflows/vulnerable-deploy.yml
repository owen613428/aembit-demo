name: ğŸš¨ Vulnerable Deployment (Demo Only - Don't Do This!)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'demo'
        type: choice
        options:
          - demo
          - staging

env:
  # ğŸš¨ SECURITY WARNING: This workflow intentionally demonstrates bad practices
  DEMO_WARNING: "This is a demonstration of vulnerable CI/CD practices"

jobs:
  vulnerable-deploy:
    runs-on: ubuntu-latest
    environment: demo
    
    steps:
    - name: ğŸš¨ Security Warning
      run: |
        echo "=================================================="
        echo "ğŸš¨ WARNING: VULNERABLE DEPLOYMENT DEMO"
        echo "This workflow demonstrates what NOT to do!"
        echo "Contains intentional security vulnerabilities"
        echo "All credentials are fake and for demo only"
        echo "=================================================="
    
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸš¨ Build Vulnerable Web App (Contains Hardcoded Secrets!)
      run: |
        echo "Building vulnerable web application..."
        cd vulnerable-webapp
        pip install -r requirements.txt
        echo "ğŸš¨ SECURITY RISK: Hardcoded secrets in application code!"
        grep -r "postgresql://" . || echo "Found hardcoded database URLs"
        grep -r "supersecret" . || echo "Found hardcoded passwords"
    
    - name: ğŸš¨ Build Vulnerable API (Contains API Keys in Code!)
      run: |
        echo "Building vulnerable API application..."
        cd vulnerable-api
        pip install -r requirements.txt
        echo "ğŸš¨ SECURITY RISK: API keys hardcoded in source code!"
        grep -r "api-key" . || echo "Found hardcoded API keys"
    
    - name: ğŸš¨ Deploy with GitHub Secrets (Still Risky!)
      env:
        # ğŸš¨ SECURITY RISK: Secrets in environment variables
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        EXTERNAL_API_KEY: ${{ secrets.EXTERNAL_API_KEY }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
      run: |
        echo "=================================================="
        echo "ğŸš¨ DEPLOYING WITH SECRETS IN ENVIRONMENT"
        echo "=================================================="
        echo "Database URL: $DATABASE_URL"
        echo "API Key: $EXTERNAL_API_KEY" 
        echo "JWT Secret: $JWT_SECRET"
        echo ""
        echo "ğŸš¨ SECURITY ISSUES DEMONSTRATED:"
        echo "1. Secrets visible in GitHub Actions logs (like above!)"
        echo "2. Anyone with repo access can see these secrets"
        echo "3. Secrets stored in multiple places (GitHub + code)"
        echo "4. Manual secret rotation required"
        echo "5. No audit trail of secret usage"
        echo "6. Environment variables expose credentials"
        echo ""
        echo "Applications 'deployed' to demo environment:"
        echo "- Web App: https://demo-vulnerable.example.com"
        echo "- API: https://api-demo-vulnerable.example.com"
    
    - name: ğŸš¨ Container Security Scan (Finds Secrets!)
      run: |
        echo "Scanning for secrets in application code..."
        echo ""
        echo "ğŸš¨ SECRETS FOUND IN CODE:"
        find . -name "*.py" -exec grep -l "postgresql://\|api-key\|secret" {} \; || true
        echo ""
        echo "ğŸš¨ ENVIRONMENT VARIABLES WITH SECRETS:"
        env | grep -E "(DATABASE|API|SECRET)" || true
    
    - name: ğŸ“Š Generate Vulnerability Report
      run: |
        cat > vulnerability-report.md << 'EOF'
        # ğŸš¨ Vulnerability Assessment Report
        
        ## Critical Security Issues Found
        
        ### 1. Hardcoded Secrets in Source Code
        - âŒ Database URLs with credentials in config files
        - âŒ API keys embedded directly in Python code
        - âŒ JWT secrets hardcoded in application files
        - âŒ Passwords stored in plain text
        
        ### 2. CI/CD Pipeline Secrets Exposure
        - âŒ Secrets visible in GitHub Actions logs
        - âŒ Environment variables expose credentials
        - âŒ Anyone with repository access can view secrets
        - âŒ No encryption of secrets in transit
        
        ### 3. Operational Security
        - âŒ Manual secret rotation process
        - âŒ No audit trail of secret access
        - âŒ Shared secrets across environments
        - âŒ No credential lifecycle management
        
        ## Risk Assessment: CRITICAL
        
        **Complete credential exposure across entire pipeline**
        
        ## Recommendations
        
        1. âœ… Implement Aembit for workload identity
        2. âœ… Remove all hardcoded secrets from code
        3. âœ… Use OIDC tokens for CI/CD authentication
        4. âœ… Implement just-in-time credential delivery
        
        **URGENT**: Run the secure deployment workflow to see the transformation.
        EOF
    
    - name: Upload Vulnerability Report
      uses: actions/upload-artifact@v4
      with:
        name: vulnerability-assessment-report
        path: vulnerability-report.md
        retention-days: 30